<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Lending Marketplace</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .container {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        button {
            background-color: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        button:hover {
            background-color: #5a67d8;
            transform: translateY(-1px);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        input, select {
            padding: 10px;
            margin: 5px;
            border: 2px solid #e1e4e8;
            border-radius: 5px;
            width: 200px;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        .marketplace {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }
        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            height: fit-content;
        }
        .loan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .loan-card {
            background: white;
            border: 2px solid #e1e4e8;
            padding: 20px;
            border-radius: 8px;
            transition: all 0.3s;
            position: relative;
        }
        .loan-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }
        .loan-id {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
        }
        .loan-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin: 5px 0;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-funded {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-repaid {
            background: #d4edda;
            color: #155724;
        }
        .loan-details {
            margin: 10px 0;
            line-height: 1.6;
        }
        .loan-details strong {
            color: #495057;
            display: inline-block;
            width: 120px;
        }
        .filter-section {
            margin-bottom: 20px;
        }
        .filter-section h3 {
            margin-bottom: 10px;
            color: #495057;
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e1e4e8;
        }
        .tab-button {
            background: none;
            color: #6c757d;
            border: none;
            padding: 15px 30px;
            border-radius: 0;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-button:hover {
            background: none;
            color: #495057;
            transform: none;
        }
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: none;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-box input {
            flex: 1;
            width: auto;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .empty-state h3 {
            color: #495057;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè¶ P2P Lending Marketplace</h1>
        <p>Decentralized Peer-to-Peer Lending on Sepolia Testnet</p>
    </div>
    
    <!-- Connection Status -->
    <div class="container">
        <h2>üëõ Wallet Connection</h2>
        <button onclick="connectWallet()">Connect MetaMask</button>
        <div id="connectionStatus"></div>
    </div>

    <!-- Main Interface -->
    <div id="mainInterface" style="display: none;">
        <div class="container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('marketplace')">üè™ Marketplace</button>
                <button class="tab-button" onclick="switchTab('borrow')">üí∏ Borrow</button>
                <button class="tab-button" onclick="switchTab('myloans')">üìã My Loans</button>
            </div>

            <!-- Marketplace Tab -->
            <div id="marketplaceTab" class="tab-content active">
                <h2>Loan Marketplace</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalLoans">0</div>
                        <div class="stat-label">Total Loans</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="availableLoans">0</div>
                        <div class="stat-label">Available to Fund</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalVolume">0 ETH</div>
                        <div class="stat-label">Total Volume</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="number" id="searchLoanId" placeholder="Search by Loan ID (e.g., 1, 2, 3)">
                    <button onclick="searchLoanById()">üîç Search</button>
                    <button onclick="loadMarketplace()">üîÑ Refresh All</button>
                </div>

                <div class="marketplace">
                    <div class="filters">
                        <h3>üéØ Filters</h3>
                        
                        <div class="filter-section">
                            <label>Status</label>
                            <select id="filterStatus" onchange="applyFilters()">
                                <option value="all">All Loans</option>
                                <option value="pending" selected>Available to Fund</option>
                                <option value="funded">Already Funded</option>
                                <option value="repaid">Repaid</option>
                                <option value="my-loans">My Loans Only</option>
                                <option value="fundable">Loans I Can Fund</option>
                            </select>
                        </div>

                        <div class="filter-section">
                            <label>Amount Range (ETH)</label>
                            <input type="number" id="filterMinAmount" placeholder="Min" step="0.001" onchange="applyFilters()">
                            <input type="number" id="filterMaxAmount" placeholder="Max" step="0.001" onchange="applyFilters()">
                        </div>

                        <div class="filter-section">
                            <label>Interest Rate (%)</label>
                            <input type="number" id="filterMinInterest" placeholder="Min" onchange="applyFilters()">
                            <input type="number" id="filterMaxInterest" placeholder="Max" onchange="applyFilters()">
                        </div>

                        <div class="filter-section">
                            <label>Duration</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" id="filterMaxDuration" placeholder="Max" onchange="applyFilters()" style="width: 80px;">
                                <select id="filterDurationUnit" onchange="applyFilters()" style="width: 70px;">
                                    <option value="minutes">Min</option>
                                    <option value="days" selected>Days</option>
                                    <option value="months">Mon</option>
                                    <option value="years">Yrs</option>
                                </select>
                            </div>
                        </div>

                        <button onclick="clearFilters()">Clear Filters</button>
                    </div>

                    <div>
                        <div id="loanGrid" class="loan-grid">
                            <!-- Loans will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Borrow Tab -->
            <div id="borrowTab" class="tab-content">
                <h2>Create a Loan Request</h2>
                
                <div class="info-box">
                    <strong>‚ÑπÔ∏è How it works:</strong><br>
                    1. Create a loan request with your desired terms<br>
                    2. Your loan gets a unique ID (like #1, #2, etc.)<br>
                    3. Lenders can browse and fund your loan<br>
                    4. Once funded, you receive the ETH instantly<br>
                    5. Repay the loan + interest before the deadline
                </div>

                <div class="form-group">
                    <label>Amount to Borrow (ETH)</label>
                    <input type="number" id="loanAmount" placeholder="0.01" step="0.001" min="0.001">
                </div>

                <div class="form-group">
                    <label>Interest Rate You'll Pay (%)</label>
                    <input type="number" id="interestRate" placeholder="10" step="0.1" min="0.1">
                </div>

                <div class="form-group">
                    <label>Repayment Period</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="duration" placeholder="30" min="1" style="width: 120px;">
                        <select id="durationUnit" style="width: 100px;">
                            <option value="minutes">Minutes</option>
                            <option value="days" selected>Days</option>
                            <option value="months">Months</option>
                            <option value="years">Years</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <button onclick="calculateRepayment()">Calculate Total Repayment</button>
                    <div id="repaymentPreview"></div>
                </div>

                <button onclick="createLoanRequest()">Create Loan Request</button>
                
                <div id="loanCreatedSuccess" class="success-box">
                    <h3>‚úÖ Loan Request Created Successfully!</h3>
                    <p>Your Loan ID is: <strong id="newLoanId">#</strong></p>
                    <p>Share this ID with potential lenders or wait for someone to fund it from the marketplace.</p>
                </div>
            </div>

            <!-- My Loans Tab -->
            <div id="myloansTab" class="tab-content">
                <h2>My Loans</h2>
                <button onclick="loadMyLoans()">üîÑ Refresh My Loans</button>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="myBorrowedCount">0</div>
                        <div class="stat-label">Loans as Borrower</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="myLentCount">0</div>
                        <div class="stat-label">Loans as Lender</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="myTotalOwed">0 ETH</div>
                        <div class="stat-label">Total to Repay</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="myTotalLent">0 ETH</div>
                        <div class="stat-label">Total Lent Out</div>
                    </div>
                </div>

                <h3>üì§ My Borrowed Loans</h3>
                <div id="myBorrowedLoans" class="loan-grid"></div>

                <h3>üì• My Funded Loans</h3>
                <div id="myFundedLoans" class="loan-grid"></div>
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div class="container">
        <h2>üìù Transaction Log</h2>
        <div id="statusMessages"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        const CONTRACT_ADDRESS = "0x4dcfb9a7029a1611468Ab8BeA3Fc49f5F8d751C5";
        
        const CONTRACT_ABI = [
            "function createLoanRequest(uint256 _amount, uint256 _interestRate, uint256 _duration) returns (uint256)",
            "function fundLoan(uint256 _requestId) payable",
            "function repayLoan(uint256 _requestId) payable",
            "function getLoanRequest(uint256 _requestId) view returns (tuple(uint256 id, address borrower, uint256 amount, uint256 interestRate, uint256 duration, uint256 createdAt, bool isFunded, bool isRepaid, address lender, uint256 fundedAt, uint256 repaymentAmount))",
            "function getBorrowerLoans(address _borrower) view returns (uint256[])",
            "function getLenderLoans(address _lender) view returns (uint256[])",
            "function loanRequestCounter() view returns (uint256)",
            "function isLoanOverdue(uint256 _requestId) view returns (bool)",
            "event LoanRequestCreated(uint256 indexed requestId, address indexed borrower, uint256 amount, uint256 interestRate, uint256 duration)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;
        let allLoans = [];

        function convertDurationToSeconds(value, unit) {
            switch(unit) {
                case 'minutes': return value * 60;
                case 'days': return value * 86400;
                case 'months': return value * 30 * 86400;
                case 'years': return value * 365 * 86400;
                default: return value * 86400;
            }
        }

        function formatDuration(seconds) {
            const years = Math.floor(seconds / (365 * 86400));
            const months = Math.floor((seconds % (365 * 86400)) / (30 * 86400));
            const days = Math.floor((seconds % (30 * 86400)) / 86400);
            const minutes = Math.floor(seconds / 60);
            
            if (years > 0) return `${years} year${years > 1 ? 's' : ''}${months > 0 ? ` ${months} month${months > 1 ? 's' : ''}` : ''}`;
            if (months > 0) return `${months} month${months > 1 ? 's' : ''}${days > 0 ? ` ${days} day${days > 1 ? 's' : ''}` : ''}`;
            if (days > 0) return `${days} day${days > 1 ? 's' : ''}`;
            return `${minutes} minute${minutes > 1 ? 's' : ''}`;
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessages');
            const messageDiv = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            messageDiv.style.padding = '10px';
            messageDiv.style.margin = '5px 0';
            messageDiv.style.borderRadius = '5px';
            messageDiv.style.background = type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : '#d1ecf1';
            messageDiv.style.color = type === 'error' ? '#721c24' : type === 'success' ? '#155724' : '#0c5460';
            messageDiv.innerHTML = `<strong>${time}</strong> - ${message}`;
            statusDiv.insertBefore(messageDiv, statusDiv.firstChild);
            
            while (statusDiv.children.length > 5) {
                statusDiv.removeChild(statusDiv.lastChild);
            }
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('Please install MetaMask!', 'error');
                    return;
                }

                showStatus('Connecting to MetaMask...', 'info');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                const network = await provider.getNetwork();
                
                document.getElementById('connectionStatus').innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin-top: 10px;">
                        <strong>‚úÖ Connected!</strong><br>
                        Address: ${userAddress}<br>
                        Network: ${network.name} (Chain ID: ${network.chainId})
                    </div>
                `;
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                document.getElementById('mainInterface').style.display = 'block';
                
                showStatus('Successfully connected!', 'success');
                loadMarketplace();
                
                // Listen for loan creation events
                contract.on("LoanRequestCreated", (requestId, borrower, amount, interestRate, duration) => {
                    if (borrower.toLowerCase() === userAddress.toLowerCase()) {
                        document.getElementById('newLoanId').textContent = `#${requestId}`;
                        document.getElementById('loanCreatedSuccess').style.display = 'block';
                    }
                    loadMarketplace();
                });
                
            } catch (error) {
                console.error(error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`#${tab}Tab`).classList.add('active');
            event.target.classList.add('active');
            
            if (tab === 'myloans') {
                loadMyLoans();
            }
        }

        async function loadMarketplace() {
            try {
                showStatus('Loading marketplace...', 'info');
                
                // Clear search box when loading all loans
                document.getElementById('searchLoanId').value = '';
                
                const loanCount = await contract.loanRequestCounter();
                allLoans = [];
                
                let totalVolume = ethers.BigNumber.from(0);
                let availableCount = 0;
                
                for (let i = 1; i <= loanCount; i++) {
                    const loan = await contract.getLoanRequest(i);
                    const isOverdue = await contract.isLoanOverdue(i);
                    
                    allLoans.push({
                        ...loan,
                        isOverdue
                    });
                    
                    totalVolume = totalVolume.add(loan.amount);
                    if (!loan.isFunded) availableCount++;
                }
                
                document.getElementById('totalLoans').textContent = loanCount.toString();
                document.getElementById('availableLoans').textContent = availableCount.toString();
                document.getElementById('totalVolume').textContent = ethers.utils.formatEther(totalVolume) + ' ETH';
                
                applyFilters();
                showStatus('Marketplace loaded', 'success');
                
            } catch (error) {
                console.error(error);
                showStatus(`Error loading marketplace: ${error.message}`, 'error');
            }
        }

        function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const minAmount = parseFloat(document.getElementById('filterMinAmount').value) || 0;
            const maxAmount = parseFloat(document.getElementById('filterMaxAmount').value) || Infinity;
            const minInterest = parseFloat(document.getElementById('filterMinInterest').value) || 0;
            const maxInterest = parseFloat(document.getElementById('filterMaxInterest').value) || Infinity;
            const maxDurationValue = parseInt(document.getElementById('filterMaxDuration').value);
            const maxDurationUnit = document.getElementById('filterDurationUnit').value;
            const maxDuration = maxDurationValue ? convertDurationToSeconds(maxDurationValue, maxDurationUnit) : Infinity;
            
            const filteredLoans = allLoans.filter(loan => {
                const amount = parseFloat(ethers.utils.formatEther(loan.amount));
                const interest = loan.interestRate / 100;
                const duration = loan.duration;
                
                if (status !== 'all') {
                    if (status === 'pending' && loan.isFunded) return false;
                    if (status === 'funded' && (!loan.isFunded || loan.isRepaid)) return false;
                    if (status === 'repaid' && !loan.isRepaid) return false;
                    if (status === 'my-loans' && loan.borrower.toLowerCase() !== userAddress.toLowerCase()) return false;
                    if (status === 'fundable' && (loan.isFunded || loan.borrower.toLowerCase() === userAddress.toLowerCase())) return false;
                }
                
                if (amount < minAmount || amount > maxAmount) return false;
                if (interest < minInterest || interest > maxInterest) return false;
                if (duration > maxDuration) return false;
                
                return true;
            });
            
            displayLoans(filteredLoans);
        }

        function displayLoans(loans) {
            const grid = document.getElementById('loanGrid');
            
            if (loans.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <h3>No loans found</h3>
                        <p>Try adjusting your filters or create a new loan request</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = loans.map(loan => {
                const status = loan.isRepaid ? 'repaid' : (loan.isFunded ? 'funded' : 'pending');
                const statusText = loan.isRepaid ? 'Repaid' : (loan.isFunded ? 'Funded' : 'Available');
                const canFund = !loan.isFunded;
                const isOwnLoan = loan.borrower.toLowerCase() === userAddress.toLowerCase();
                
                return `
                    <div class="loan-card" ${loan.borrower.toLowerCase() === userAddress.toLowerCase() ? 'style="border: 3px solid #667eea; background: #f0f5ff;"' : ''}>
                        <div class="loan-id">#${loan.id}</div>
                        <div class="loan-status status-${status}">${statusText}</div>
                        ${loan.isOverdue && !loan.isRepaid ? '<div class="loan-status" style="background: #f8d7da; color: #721c24;">OVERDUE</div>' : ''}
                        ${loan.borrower.toLowerCase() === userAddress.toLowerCase() ? '<div class="loan-status" style="background: #667eea; color: white;">YOUR LOAN</div>' : ''}
                        
                        <div class="loan-details">
                            <strong>Amount:</strong> ${ethers.utils.formatEther(loan.amount)} ETH<br>
                            <strong>Interest:</strong> ${loan.interestRate / 100}%<br>
                            <strong>Duration:</strong> ${formatDuration(loan.duration)}<br>
                            <strong>Total Repay:</strong> ${ethers.utils.formatEther(loan.repaymentAmount)} ETH<br>
                            <strong>Borrower:</strong> ${loan.borrower.substring(0, 6)}...${loan.borrower.substring(38)}
                            ${loan.borrower.toLowerCase() === userAddress.toLowerCase() ? ' (You)' : ''}
                        </div>
                        
                        ${canFund ? `
                            <button onclick="fundLoan(${loan.id}, '${loan.amount}')" style="width: 100%; margin-top: 15px; background-color: ${isOwnLoan ? '#ffc107' : '#28a745'}; color: ${isOwnLoan ? '#000' : '#fff'}; font-size: 16px;">
                                ${isOwnLoan ? 'üß™ Fund Own Loan (TESTING)' : 'üí∞ Fund This Loan'} (${ethers.utils.formatEther(loan.amount)} ETH)
                            </button>
                        ` : ''}
                        
                        ${loan.borrower.toLowerCase() === userAddress.toLowerCase() && !loan.isFunded ? 
                            '<div style="text-align: center; color: #6c757d; margin-top: 15px; font-style: italic;">‚è≥ Waiting for a lender to fund your loan</div>' : ''}
                        
                        ${loan.borrower.toLowerCase() === userAddress.toLowerCase() && loan.isFunded && !loan.isRepaid ? 
                            `<button onclick="repayLoan(${loan.id}, '${loan.repaymentAmount}')" style="width: 100%; margin-top: 15px;">
                                üí≥ Repay Loan (${ethers.utils.formatEther(loan.repaymentAmount)} ETH)
                            </button>` : ''}
                        
                        ${loan.lender && loan.lender.toLowerCase() === userAddress.toLowerCase() && loan.isFunded && !loan.isRepaid ? 
                            '<div style="text-align: center; color: #28a745; margin-top: 15px; font-weight: bold;">‚úÖ You funded this loan</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        async function searchLoanById() {
            const loanId = document.getElementById('searchLoanId').value;
            if (!loanId) {
                showStatus('Please enter a loan ID', 'error');
                return;
            }
            
            try {
                showStatus(`Searching for Loan #${loanId}...`, 'info');
                const loan = await contract.getLoanRequest(loanId);
                if (loan.id == 0) {
                    showStatus(`Loan #${loanId} not found`, 'error');
                    return;
                }
                
                const isOverdue = await contract.isLoanOverdue(loanId);
                
                // Update allLoans to contain only the searched loan for consistency with filters
                allLoans = [{ ...loan, isOverdue }];
                displayLoans(allLoans);
                showStatus(`Showing Loan #${loanId}`, 'success');
                
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function clearFilters() {
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterMinAmount').value = '';
            document.getElementById('filterMaxAmount').value = '';
            document.getElementById('filterMinInterest').value = '';
            document.getElementById('filterMaxInterest').value = '';
            document.getElementById('filterMaxDuration').value = '';
            document.getElementById('filterDurationUnit').value = 'days';
            document.getElementById('searchLoanId').value = '';
            applyFilters();
        }

        function calculateRepayment() {
            const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            
            if (amount && interestRate) {
                const interest = amount * (interestRate / 100);
                const total = amount + interest;
                
                document.getElementById('repaymentPreview').innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                        <strong>Loan Breakdown:</strong><br>
                        Principal: ${amount} ETH<br>
                        Interest (${interestRate}%): ${interest.toFixed(4)} ETH<br>
                        <strong>Total Repayment: ${total.toFixed(4)} ETH</strong>
                    </div>
                `;
            }
        }

        async function createLoanRequest() {
            try {
                const amount = document.getElementById('loanAmount').value;
                const interestRate = document.getElementById('interestRate').value;
                const duration = document.getElementById('duration').value;
                
                if (!amount || !interestRate || !duration) {
                    showStatus('Please fill in all fields', 'error');
                    return;
                }
                
                showStatus('Creating loan request...', 'info');
                
                const amountWei = ethers.utils.parseEther(amount);
                const interestRateBps = Math.floor(parseFloat(interestRate) * 100);
                const durationUnit = document.getElementById('durationUnit').value;
                const durationSeconds = convertDurationToSeconds(parseInt(duration), durationUnit);
                
                const tx = await contract.createLoanRequest(amountWei, interestRateBps, durationSeconds);
                showStatus(`Transaction submitted: ${tx.hash.substring(0, 10)}...`, 'info');
                
                await tx.wait();
                showStatus('Loan request created successfully!', 'success');
                
                document.getElementById('loanAmount').value = '';
                document.getElementById('interestRate').value = '';
                document.getElementById('duration').value = '';
                document.getElementById('repaymentPreview').innerHTML = '';
                
                loadMarketplace();
                
            } catch (error) {
                console.error(error);
                showStatus(`Error: ${error.reason || error.message}`, 'error');
            }
        }

        async function fundLoan(loanId, amount) {
            try {
                if (confirm(`Fund Loan #${loanId} with ${ethers.utils.formatEther(amount)} ETH?`)) {
                    showStatus(`Funding loan #${loanId}...`, 'info');
                    
                    const tx = await contract.fundLoan(loanId, { value: amount });
                    showStatus(`Transaction submitted: ${tx.hash.substring(0, 10)}...`, 'info');
                    
                    await tx.wait();
                    showStatus(`Successfully funded loan #${loanId}!`, 'success');
                    
                    loadMarketplace();
                }
            } catch (error) {
                console.error(error);
                showStatus(`Error: ${error.reason || error.message}`, 'error');
            }
        }

        async function repayLoan(loanId, repaymentAmount) {
            try {
                if (confirm(`Repay Loan #${loanId} with ${ethers.utils.formatEther(repaymentAmount)} ETH?`)) {
                    showStatus(`Repaying loan #${loanId}...`, 'info');
                    
                    const tx = await contract.repayLoan(loanId, { value: repaymentAmount });
                    showStatus(`Transaction submitted: ${tx.hash.substring(0, 10)}...`, 'info');
                    
                    await tx.wait();
                    showStatus(`Successfully repaid loan #${loanId}!`, 'success');
                    
                    loadMarketplace();
                    loadMyLoans();
                }
            } catch (error) {
                console.error(error);
                showStatus(`Error: ${error.reason || error.message}`, 'error');
            }
        }

        async function loadMyLoans() {
            try {
                showStatus('Loading your loans...', 'info');
                
                const borrowedLoans = await contract.getBorrowerLoans(userAddress);
                const lentLoans = await contract.getLenderLoans(userAddress);
                
                let totalOwed = ethers.BigNumber.from(0);
                let totalLent = ethers.BigNumber.from(0);
                
                // Display borrowed loans
                const borrowedDiv = document.getElementById('myBorrowedLoans');
                if (borrowedLoans.length === 0) {
                    borrowedDiv.innerHTML = '<div class="empty-state">No loans as borrower</div>';
                } else {
                    const borrowedHTML = await Promise.all(borrowedLoans.map(async (loanId) => {
                        const loan = await contract.getLoanRequest(loanId);
                        const isOverdue = await contract.isLoanOverdue(loanId);
                        
                        if (loan.isFunded && !loan.isRepaid) {
                            totalOwed = totalOwed.add(loan.repaymentAmount);
                        }
                        
                        const status = loan.isRepaid ? 'repaid' : (loan.isFunded ? 'funded' : 'pending');
                        const statusText = loan.isRepaid ? 'Repaid' : (loan.isFunded ? 'Active' : 'Waiting for Funding');
                        
                        return `
                            <div class="loan-card">
                                <div class="loan-id">#${loan.id}</div>
                                <div class="loan-status status-${status}">${statusText}</div>
                                ${isOverdue && !loan.isRepaid ? '<div class="loan-status" style="background: #f8d7da; color: #721c24;">OVERDUE</div>' : ''}
                                <div class="loan-details">
                                    <strong>Borrowed:</strong> ${ethers.utils.formatEther(loan.amount)} ETH<br>
                                    <strong>Total Due:</strong> ${ethers.utils.formatEther(loan.repaymentAmount)} ETH<br>
                                    <strong>Interest:</strong> ${loan.interestRate / 100}%<br>
                                    <strong>Duration:</strong> ${formatDuration(loan.duration)}
                                </div>
                                ${loan.isFunded && !loan.isRepaid ? 
                                    `<button onclick="repayLoan(${loan.id}, '${loan.repaymentAmount}')">Repay Loan</button>` : ''}
                            </div>
                        `;
                    }));
                    borrowedDiv.innerHTML = borrowedHTML.join('');
                }
                
                // Display lent loans
                const lentDiv = document.getElementById('myFundedLoans');
                if (lentLoans.length === 0) {
                    lentDiv.innerHTML = '<div class="empty-state">No loans as lender</div>';
                } else {
                    const lentHTML = await Promise.all(lentLoans.map(async (loanId) => {
                        const loan = await contract.getLoanRequest(loanId);
                        const isOverdue = await contract.isLoanOverdue(loanId);
                        
                        totalLent = totalLent.add(loan.amount);
                        
                        const status = loan.isRepaid ? 'repaid' : 'funded';
                        const statusText = loan.isRepaid ? 'Repaid' : 'Active';
                        
                        return `
                            <div class="loan-card">
                                <div class="loan-id">#${loan.id}</div>
                                <div class="loan-status status-${status}">${statusText}</div>
                                ${isOverdue && !loan.isRepaid ? '<div class="loan-status" style="background: #f8d7da; color: #721c24;">OVERDUE</div>' : ''}
                                <div class="loan-details">
                                    <strong>Lent:</strong> ${ethers.utils.formatEther(loan.amount)} ETH<br>
                                    <strong>Expected Return:</strong> ${ethers.utils.formatEther(loan.repaymentAmount)} ETH<br>
                                    <strong>Interest:</strong> ${loan.interestRate / 100}%<br>
                                    <strong>Borrower:</strong> ${loan.borrower.substring(0, 6)}...${loan.borrower.substring(38)}
                                </div>
                            </div>
                        `;
                    }));
                    lentDiv.innerHTML = lentHTML.join('');
                }
                
                // Update stats
                document.getElementById('myBorrowedCount').textContent = borrowedLoans.length;
                document.getElementById('myLentCount').textContent = lentLoans.length;
                document.getElementById('myTotalOwed').textContent = ethers.utils.formatEther(totalOwed) + ' ETH';
                document.getElementById('myTotalLent').textContent = ethers.utils.formatEther(totalLent) + ' ETH';
                
                showStatus('Your loans loaded', 'success');
                
            } catch (error) {
                console.error(error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        // Auto-connect if previously connected
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectWallet();
            }
        });
    </script>
</body>
</html>